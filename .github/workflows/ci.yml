name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      build_all:
        description: 'Build all modules'
        type: boolean
        default: true
      modules:
        description: 'Specific modules (comma-separated: common,user-ms,communication-ms,translation-ms,document-ms)'
        type: string
        required: false

env:
  MAVEN_OPTS: -Xmx1024m
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/corems

jobs:
  # Detect which modules changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.changes.outputs.common }}
      user-ms: ${{ steps.changes.outputs.user-ms }}
      communication-ms: ${{ steps.changes.outputs.communication-ms }}
      translation-ms: ${{ steps.changes.outputs.translation-ms }}
      document-ms: ${{ steps.changes.outputs.document-ms }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            common:
              - 'common/**'
              - 'pom.xml'
            user-ms:
              - 'user-ms/**'
              - 'pom.xml'
            communication-ms:
              - 'communication-ms/**'
              - 'pom.xml'
            translation-ms:
              - 'translation-ms/**'
              - 'pom.xml'
            document-ms:
              - 'document-ms/**'
              - 'pom.xml'

  # Build common module first (dependency for all others)
  build-common:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.common == 'true' || 
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (inputs.build_all || contains(inputs.modules, 'common')))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build common module
        run: mvn -B -pl common -am clean install

      - name: Upload common artifacts
        uses: actions/upload-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 1


  # Build and test microservices in parallel
  build-microservices:
    needs: [detect-changes, build-common]
    if: |
      always() && 
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped') &&
      (needs.detect-changes.outputs.user-ms == 'true' || 
       needs.detect-changes.outputs.communication-ms == 'true' || 
       needs.detect-changes.outputs.translation-ms == 'true' || 
       needs.detect-changes.outputs.document-ms == 'true' ||
       github.event_name == 'release' ||
       github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: user-ms
            changed: ${{ needs.detect-changes.outputs.user-ms }}
          - module: communication-ms
            changed: ${{ needs.detect-changes.outputs.communication-ms }}
          - module: translation-ms
            changed: ${{ needs.detect-changes.outputs.translation-ms }}
          - module: document-ms
            changed: ${{ needs.detect-changes.outputs.document-ms }}
    
    steps:
      - name: Check if should build
        id: should-build
        run: |
          if [[ "${{ matrix.changed }}" == "true" || \
                "${{ needs.detect-changes.outputs.common }}" == "true" || \
                "${{ github.event_name }}" == "release" || \
                ("${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.build_all }}" == "true") || \
                ("${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.modules }}" == *"${{ matrix.module }}"*) ]]; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.should-build.outputs.build == 'true'
        uses: actions/checkout@v4

      - name: Setup Java 25
        if: steps.should-build.outputs.build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        if: steps.should-build.outputs.build == 'true' && needs.build-common.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/

      - name: Build and test ${{ matrix.module }}
        if: steps.should-build.outputs.build == 'true'
        run: mvn -B -pl ${{ matrix.module }} -amd -am clean verify

      - name: Upload test results
        if: steps.should-build.outputs.build == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.module }}
          path: ${{ matrix.module }}/**/target/surefire-reports/
          retention-days: 7
          if-no-files-found: ignore

  # Build and push Docker images on release
  docker:
    needs: [detect-changes, build-common, build-microservices]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        module: [user-ms, communication-ms, translation-ms, document-ms]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/

      - name: Build JAR
        run: mvn -B -pl ${{ matrix.module }} -am clean package -DskipTests

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.module }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.module }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
