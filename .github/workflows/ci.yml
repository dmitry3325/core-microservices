name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      modules:
        description: 'Modules to build (comma-separated: all, common, user-ms, communication-ms, translation-ms, document-ms)'
        type: string
        default: 'all'
        required: true

env:
  MAVEN_OPTS: -Xmx1024m
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/corems

jobs:
  # Detect which modules changed (for push/PR)
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.changes.outputs.common }}
      user-ms: ${{ steps.changes.outputs.user-ms }}
      communication-ms: ${{ steps.changes.outputs.communication-ms }}
      translation-ms: ${{ steps.changes.outputs.translation-ms }}
      document-ms: ${{ steps.changes.outputs.document-ms }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            common:
              - 'common/**'
              - 'pom.xml'
            user-ms:
              - 'user-ms/**'
              - 'pom.xml'
            communication-ms:
              - 'communication-ms/**'
              - 'pom.xml'
            translation-ms:
              - 'translation-ms/**'
              - 'pom.xml'
            document-ms:
              - 'document-ms/**'
              - 'pom.xml'


  # Build common module (only when needed)
  build-common:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.common == 'true' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (contains(inputs.modules, 'all') || contains(inputs.modules, 'common')))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and test common module
        run: mvn -B -pl common -amd clean verify -Denforcer.skip=true

      - name: Upload common artifacts to cache
        uses: actions/upload-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 1

  # Build microservices
  build-microservices:
    needs: [detect-changes, build-common]
    if: |
      always() &&
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: user-ms
            changed: ${{ needs.detect-changes.outputs.user-ms }}
          - module: communication-ms
            changed: ${{ needs.detect-changes.outputs.communication-ms }}
          - module: translation-ms
            changed: ${{ needs.detect-changes.outputs.translation-ms }}
          - module: document-ms
            changed: ${{ needs.detect-changes.outputs.document-ms }}
    steps:
      - name: Check if should build
        id: should-build
        run: |
          MODULE="${{ matrix.module }}"
          CHANGED="${{ matrix.changed }}"
          COMMON_CHANGED="${{ needs.detect-changes.outputs.common }}"
          EVENT="${{ github.event_name }}"
          MODULES_INPUT="${{ inputs.modules }}"
          
          SHOULD_BUILD="false"
          
          # Push/PR: build if module or common changed
          if [[ "$EVENT" == "push" || "$EVENT" == "pull_request" ]]; then
            if [[ "$CHANGED" == "true" || "$COMMON_CHANGED" == "true" ]]; then
              SHOULD_BUILD="true"
            fi
          fi
          
          # Release: always build all
          if [[ "$EVENT" == "release" ]]; then
            SHOULD_BUILD="true"
          fi
          
          # Manual: check if module is in the list
          if [[ "$EVENT" == "workflow_dispatch" ]]; then
            if [[ "$MODULES_INPUT" == *"all"* || "$MODULES_INPUT" == *"$MODULE"* ]]; then
              SHOULD_BUILD="true"
            fi
          fi
          
          echo "build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "Building $MODULE: $SHOULD_BUILD"

      - name: Checkout code
        if: steps.should-build.outputs.build == 'true'
        uses: actions/checkout@v4

      - name: Setup Java 25
        if: steps.should-build.outputs.build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        if: steps.should-build.outputs.build == 'true' && needs.build-common.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/

      - name: Build common first (if not already built)
        if: steps.should-build.outputs.build == 'true' && needs.build-common.result != 'success'
        run: mvn -B -pl common -amd clean install -Denforcer.skip=true

      - name: Build and test ${{ matrix.module }}
        if: steps.should-build.outputs.build == 'true'
        run: mvn -B -pl ${{ matrix.module }} -amd clean verify -Denforcer.skip=true

      - name: Upload test results
        if: steps.should-build.outputs.build == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.module }}
          path: ${{ matrix.module }}/**/target/surefire-reports/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload module artifacts
        if: steps.should-build.outputs.build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 7

  # SonarCloud analysis (runs after all builds complete)
  sonar:
    needs: [build-common, build-microservices]
    if: |
      always() &&
      (needs.build-common.result == 'success' || needs.build-microservices.result == 'success') &&
      github.event_name != 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and analyze with SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=${{ github.repository_owner }}_corems \
            -Dsonar.organization=${{ github.repository_owner }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Denforcer.skip=true

  # Build and push Docker images on release
  docker:
    needs: [detect-changes, build-common, build-microservices]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        module: [user-ms, communication-ms, translation-ms, document-ms]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/

      - name: Build JAR
        run: mvn -B -pl ${{ matrix.module }} -amd clean package -DskipTests -Denforcer.skip=true

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.module }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.module }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
