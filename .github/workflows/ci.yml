name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      modules:
        description: 'Modules to build (comma-separated: all, common, or specific like user-ms)'
        type: string
        default: 'all'
        required: true
      run_sonar:
        description: 'Run SonarCloud analysis'
        type: boolean
        default: false

env:
  MAVEN_OPTS: -Xmx1024m
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/corems

jobs:
  # Discover all *-ms modules and detect changes
  setup:
    runs-on: ubuntu-latest
    outputs:
      microservices: ${{ steps.discover.outputs.microservices }}
      common-changed: ${{ steps.changes.outputs.common }}
      ms-changes: ${{ steps.changes.outputs.changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover microservices
        id: discover
        run: |
          # Find all directories ending with -ms
          MODULES=$(find . -maxdepth 1 -type d -name "*-ms" | sed 's|./||' | sort | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "microservices=$MODULES" >> $GITHUB_OUTPUT
          echo "Discovered modules: $MODULES"

      - name: Detect changes
        id: changes
        run: |
          # Check if common changed
          if git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD 2>/dev/null | grep -qE '^(common/|pom\.xml)'; then
            echo "common=true" >> $GITHUB_OUTPUT
          else
            echo "common=false" >> $GITHUB_OUTPUT
          fi
          
          # Build JSON object of which modules changed (compact, single line)
          CHANGES="{}"
          for dir in $(find . -maxdepth 1 -type d -name "*-ms" | sed 's|./||' | sort); do
            if git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD 2>/dev/null | grep -qE "^${dir}/|^pom\.xml"; then
              CHANGES=$(echo "$CHANGES" | jq -c --arg k "$dir" '. + {($k): true}')
            else
              CHANGES=$(echo "$CHANGES" | jq -c --arg k "$dir" '. + {($k): false}')
            fi
          done
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          echo "Changes detected: $CHANGES"


  # Build common module
  build-common:
    needs: setup
    if: |
      needs.setup.outputs.common-changed == 'true' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (contains(inputs.modules, 'all') || contains(inputs.modules, 'common')))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and test common module
        run: mvn -B -pl common -amd clean install -Denforcer.skip=true

      - name: Upload common artifacts
        uses: actions/upload-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 7

  # Build microservices dynamically
  build-microservices:
    needs: [setup, build-common]
    if: |
      always() &&
      (needs.build-common.result == 'success' || needs.build-common.result == 'skipped') &&
      needs.setup.outputs.microservices != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.setup.outputs.microservices) }}
    steps:
      - name: Check if should build
        id: should-build
        run: |
          MODULE="${{ matrix.module }}"
          COMMON_CHANGED="${{ needs.setup.outputs.common-changed }}"
          EVENT="${{ github.event_name }}"
          MODULES_INPUT="${{ inputs.modules }}"
          MS_CHANGES='${{ needs.setup.outputs.ms-changes }}'
          
          # Check if this specific module changed
          MODULE_CHANGED=$(echo "$MS_CHANGES" | jq -r --arg m "$MODULE" '.[$m] // false')
          
          SHOULD_BUILD="false"
          
          # Push/PR: build if module or common changed
          if [[ "$EVENT" == "push" || "$EVENT" == "pull_request" ]]; then
            if [[ "$MODULE_CHANGED" == "true" || "$COMMON_CHANGED" == "true" ]]; then
              SHOULD_BUILD="true"
            fi
          fi
          
          # Release: always build all
          if [[ "$EVENT" == "release" ]]; then
            SHOULD_BUILD="true"
          fi
          
          # Manual: check if module is in the list
          if [[ "$EVENT" == "workflow_dispatch" ]]; then
            if [[ "$MODULES_INPUT" == *"all"* || "$MODULES_INPUT" == *"$MODULE"* ]]; then
              SHOULD_BUILD="true"
            fi
          fi
          
          echo "build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
          echo "Building $MODULE: $SHOULD_BUILD"

      - name: Checkout code
        if: steps.should-build.outputs.build == 'true'
        uses: actions/checkout@v4

      - name: Setup Java 25
        if: steps.should-build.outputs.build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        if: steps.should-build.outputs.build == 'true' && needs.build-common.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/
        continue-on-error: true
        id: download-common

      - name: Build common first (if not already built or download failed)
        if: steps.should-build.outputs.build == 'true' && (needs.build-common.result != 'success' || steps.download-common.outcome == 'failure')
        run: mvn -B -pl common -amd clean install -Denforcer.skip=true

      - name: Build and test ${{ matrix.module }}
        if: steps.should-build.outputs.build == 'true'
        run: mvn -B -pl ${{ matrix.module }} -amd clean verify -Denforcer.skip=true

      - name: Upload test results
        if: steps.should-build.outputs.build == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.module }}
          path: ${{ matrix.module }}/**/target/surefire-reports/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload module artifacts
        if: steps.should-build.outputs.build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 7


  # SonarCloud analysis (manual trigger only)
  sonar:
    needs: [setup, build-common, build-microservices]
    if: |
      always() &&
      (needs.build-common.result == 'success' || needs.build-microservices.result == 'success') &&
      github.event_name == 'workflow_dispatch' && inputs.run_sonar == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and analyze with SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=dmitry3325_core-microservices \
            -Dsonar.organization=${{ github.repository_owner }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Denforcer.skip=true

  # Build and push Docker images on release
  docker:
    needs: [setup, build-common, build-microservices]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.setup.outputs.microservices) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download common artifacts
        uses: actions/download-artifact@v4
        with:
          name: common-artifacts
          path: ~/.m2/repository/com/corems/
        continue-on-error: true
        id: download-common-docker

      - name: Build common if download failed
        if: steps.download-common-docker.outcome == 'failure'
        run: mvn -B -pl common -amd clean install -DskipTests -Denforcer.skip=true

      - name: Build JAR
        run: mvn -B -pl ${{ matrix.module }} -amd clean package -DskipTests -Denforcer.skip=true

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [[ -f "${{ matrix.module }}/Dockerfile" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: No Dockerfile found for ${{ matrix.module }}"
          fi

      - name: Log in to Container Registry
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        if: steps.dockerfile.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.module }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push Docker image
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.module }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
