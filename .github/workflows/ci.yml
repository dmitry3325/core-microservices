name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      modules:
        description: 'Modules to build (comma-separated: all, common, or specific like user-ms)'
        type: string
        default: 'all'
        required: true
      run_sonar:
        description: 'Run SonarCloud analysis'
        type: boolean
        default: false

env:
  MAVEN_OPTS: -Xmx1024m
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/corems

jobs:
  # Discover all *-ms modules and detect changes
  setup:
    runs-on: ubuntu-latest
    outputs:
      microservices: ${{ steps.discover.outputs.microservices }}
      any-changed: ${{ steps.changes.outputs.any-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover microservices
        id: discover
        run: |
          MODULES=$(find . -maxdepth 1 -type d -name "*-ms" | sed 's|./||' | sort | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "microservices=$MODULES" >> $GITHUB_OUTPUT
          echo "Discovered modules: $MODULES"

      - name: Detect changes
        id: changes
        run: |
          if git diff --name-only ${{ github.event.before || 'HEAD~1' }} HEAD 2>/dev/null | grep -qE '^(common/|pom\.xml|.*-ms/)'; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
          fi

  # Build modules (handles cross-dependencies by using -am flag)
  build:
    needs: setup
    if: |
      needs.setup.outputs.any-changed == 'true' ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Determine modules to build
        id: modules
        run: |
          EVENT="${{ github.event_name }}"
          MODULES_INPUT="${{ inputs.modules }}"
          
          if [[ "$EVENT" == "workflow_dispatch" && "$MODULES_INPUT" != "all" ]]; then
            # Convert comma-separated to Maven -pl format
            # e.g., "user-ms,common" -> "common,user-ms"
            MAVEN_PL=$(echo "$MODULES_INPUT" | tr ',' '\n' | sort | tr '\n' ',' | sed 's/,$//')
            echo "maven_args=-pl ${MAVEN_PL} -am" >> $GITHUB_OUTPUT
            echo "Building specific modules: $MAVEN_PL (with dependencies)"
          else
            echo "maven_args=" >> $GITHUB_OUTPUT
            echo "Building all modules"
          fi

      - name: Build and test
        run: mvn -B clean install ${{ steps.modules.outputs.maven_args }} -Denforcer.skip=true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ~/.m2/repository/com/corems/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/target/surefire-reports/'
          retention-days: 7
          if-no-files-found: ignore

  # SonarCloud analysis (manual trigger only)
  sonar:
    needs: build
    if: |
      needs.build.result == 'success' &&
      github.event_name == 'workflow_dispatch' && inputs.run_sonar == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and analyze with SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=dmitry3325_core-microservices \
            -Dsonar.organization=${{ github.repository_owner }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Denforcer.skip=true

  # Build and push Docker images on release
  docker:
    needs: [setup, build]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.setup.outputs.microservices) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ~/.m2/repository/com/corems/

      - name: Build JAR
        run: mvn -B -pl ${{ matrix.module }} -am package -DskipTests -Denforcer.skip=true

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [[ -f "${{ matrix.module }}/Dockerfile" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: No Dockerfile found for ${{ matrix.module }}"
          fi

      - name: Log in to Container Registry
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        if: steps.dockerfile.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.module }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push Docker image
        if: steps.dockerfile.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.module }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
